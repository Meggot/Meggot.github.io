<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; utf-8;"/>
        <link rel="stylesheet" href= "../static/styles.css" type="text/css"></link>
        <title>Bradley PH Williams</title>

    </head>
    <body onload="drawScreen()">
        <div class="navbar navbar-inverse navbar-fixed-left">
            <h1 class="navbarTitle"> Bradley <span style="font-size:20px">PH</span> Williams </h1>
            <navbar>
                <ul class="nav navbar-nav">
                    <li><a class="navbar-active" href="index">About</a></li>
                    <li><a href="portfolio">Portfolio</a></li>
                    <li><a href="blog">Blog</a></li>
                </ul>
            </navbar>
        </div>
        <div id="page-wrap">
            <h1> Here's my portfolio..
            </h1>
            <div id = "soundOrbiter">
                <h2> Sound Orbit </h2>
                <p>Create your own solar systems, and it'll play its fingerprint back to you! This game uses StereoPanning to play sound sources
                    orbiting around the listening point. It is best used with headphones.
                </p>
                <div style="border: 1px solid" class="gameArea">
                    <div id="gameControls">
                        <div id="audioControls">
                            <button id="small-btn" onclick="muteAll()">Mute</button><p id="mute">Muted</p><br></br>
                            <!--<tag> Volume <output for="volume" id="volumeTell">50</output></tag>-->
                            <!--<tag><input id="volume" type="range" min="0" value = "50" max="100"step="1" oninput="outputVolumeUpdate(value)"></input><br></br></tag>-->
                        </div>
                        <form id="newPlanetForm">
                            <tag> Periapsis: <output for="periapsis" id="periapsisTell">0</output></tag>
                            <tag><input id="periapsis" type="range" min="-240" value = "0" max="240"step="1" oninput="outputPeriapsisUpdate(value)"></input><br></br></tag>
                            <tag> Frequency <output for="frequency" id="frequencyTell">300</output></tag>
                            <tag><input id="frequency" type="range" min="40" value = "300" max="3000"step="5" oninput="outputFrequencyUpdate(value)"></input><br></br></tag>
                            <tag> Speed: <input id="speed" type="number" label="Enter the speed of orbit" value="0.5" step="0.1"> </input><br></br></tag>

                        </form>
                        <button id="medium-btn" onclick="addPlanetButton()">Add Planet to Space</button><br></br>
                        <button id="medium-btn" onclick="clearAllPlanets()">Clear Space</button><br></br>
                        <button id="medium-btn" onclick="startOrbiter()"> Begin</button><br></br>
                        <button id="medium-btn" onclick="stopOrbiter()">Pause</button><br></br>
                    </div>
                    <canvas id="canvasOne" float="left" width="500" height="500"></canvas>
                    <script>
                        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        var listener = audioContext.listener;
                        var gainNode = audioContext.createGain();
                        gainNode.gain.value = 0
                        listener.setOrientation(0, 250, 0, 0, 1, 0);
                        listener.setPosition(250, 250, 0);
                        var planetWrapper = [];
                        var lastPlanetId = 0;
                        var orbitActive = false;
                        var radius = 500;
                        theCanvas = document.getElementById("canvasOne");
                        context = theCanvas.getContext("2d");
                        var mute = document.getElementById("mute");

                        function muteAll() {
                            if (mute.id == "mute") {
                                gainNode.gain.value = 1;
                                mute.id = "activated";
                                mute.innerHTML = "Unmute";
                            } else {
                                gainNode.gain.value = 0;
                                mute.id = "mute";
                                mute.innerHTML = "Mute";
                            }
                        }

                        function addPlanet(periapsis, panner, oscillator, velocity)
                        {
                            if (periapsis <= radius && oscillator != null)
                            {
                                var newPlanet = {oscilator: oscillator, playing: false, id: lastPlanetId++, xCoord: periapsis, yCoord: 250, speed: velocity, soundSource: panner, centerX: 250, centerY: 250, radius: periapsis, angle: 0};
                                console.log("New planet added: " + newPlanet.id + " playing track: " + newPlanet.audioId + "with a periapsis of " + newPlanet.xCoord);
                                planetWrapper[lastPlanetId] = newPlanet;
                            }

                        }

                        function startOrbiter() {
                            if (!orbitActive)
                            {
                                for (var i = 0; i > planetWrapper.length; i++)
                                {
                                    planetWrapper[i].oscilator.mute = true;
                                }
                                audioContext.resume();
                                orbitActive = true;
                                window.myInterval = setInterval(drawScreen, 1);
                            }
                        }

                        function stopOrbiter() {
                            if (orbitActive)
                            {
                                audioContext.suspend();
                                orbitActive = false;
                                window.clearInterval(window.myInterval);
                            }
                        }

                        function drawQuadrentLines() {
                            context.beginPath();
                            context.strokeStyle = '#230000';
                            context.moveTo(0, 250);
                            context.lineTo(500, 250);
                            context.moveTo(250, 500);
                            context.lineTo(250, 250);
                            context.stroke();
                            context.strokeStyle = '#FF0000';
                            context.moveTo(250, 250);
                            context.lineTo(250, 0);
                            context.stroke();
                        }

                        function  drawScreen() {
                            context.fillStyle = '#EEEEEE';
                            context.fillRect(0, 0, theCanvas.width, theCanvas.height);
                            context.strokeStyle = '#000000';
                            context.strokeRect(1, 1, theCanvas.width - 2, theCanvas.height - 2);
                            drawQuadrentLines();
                            for (i = 0; i < planetWrapper.length; i++)
                            {
                                if (planetWrapper[i] != null)
                                {
                                    var planetPointer = planetWrapper[i];
                                    planetPointer.xCoord = planetPointer.centerX + Math.cos(planetPointer.angle) * planetPointer.radius;
                                    planetPointer.yCoord = planetPointer.centerY + Math.sin(planetPointer.angle) * planetPointer.radius;
                                    var normalizedValue = planetPointer.xCoord / 250;
                                    console.log("Panning: " + (normalizedValue - 1));
                                    planetPointer.soundSource.pan.value = (normalizedValue - 1);
                                    console.log(planetPointer.id + "= X: " + planetPointer.soundSource.positionX + "Y: " + planetPointer.soundSource.positionY)
                                    context.fillStyle = "#000000";
                                    context.beginPath();
                                    context.arc(planetPointer.xCoord, planetPointer.yCoord, 5, 0, Math.PI * 2, true);
                                    context.closePath();
                                    context.fill();
                                    if (orbitActive)
                                    {
                                        planetPointer.angle += planetPointer.speed;
                                        //planetPointer.soundSource.positionX = planetPointer.xCoord;
                                        //planetPointer.soundSource.positionY = planetPointer.yCoord;

                                    }
                                }
                            }
                        }

                        function addPlanetButton() {

                            var newPeriapsis = document.getElementById("periapsis").value;
                            var speed = document.getElementById("speed").value;
                            var frequency = document.getElementById("frequency").value;

                            var oscillator = audioContext.createOscillator();
                            oscillator.frequency.value = frequency;

                            var stereoPanner = audioContext.createStereoPanner();

                            //var panner = audioContext.createPanner();
                            //panner.panningModel = 'HRTF';
                            //panner.distanceModel = 'inverse';
                            //panner.refDistance = 1;
                            //panner.maxDistance = 500;
                            //panner.rolloffFactor = 2;
                            //panner.coneInnerAngle = 360;
                            ////panner.coneOuterAngle = 180;
                            ////panner.coneOuterGain = 0;
                            //panner.setPosition(Math.round(newPeriapsis), 250, 300);
                            oscillator.type = 'sawtooth';
                            oscillator.connect(stereoPanner);
                            stereoPanner.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            console.log(newPeriapsis + "-" + speed + "-" + stereoPanner);
                            addPlanet(newPeriapsis, stereoPanner, oscillator, speed / 100);
                            drawScreen();
                            oscillator.start();
                        }

                        function clearAllPlanets() {
                            planetWrapper = [];
                            audioContext.close();
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            listener = audioContext.listener;
                            gainNode = audioContext.createGain();
                            if (mute.id.value = "activated")
                            {
                                gainNode.gain.value = 1;
                            } else {
                                gainNode.gain.value = 0;
                            }
                            drawScreen();
                        }

                        function outputPeriapsisUpdate(vol) {
                            document.querySelector('#periapsisTell').value = vol;
                        }

                        function outputFrequencyUpdate(freq) {
                            document.querySelector('#frequencyTell').value = freq;
                        }
                    </script>

                </div>
            </div>
        </div>
        </div>
    </body>
</html>